// Prisma Schema for POC-2
// Shared database with all service models
// Reference: docs/References/backend-poc2-architecture.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum UserRole {
  ADMIN
  CUSTOMER
  VENDOR
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  cancelled
}

enum PaymentType {
  instant
  scheduled
  recurring
}

// ============================================================================
// Auth Service Schema
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          UserRole
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  refreshTokens    RefreshToken[]
  sentPayments     Payment[]         @relation("SentPayments")
  receivedPayments Payment[]         @relation("ReceivedPayments")
  auditLogs        AuditLog[]
  profile          UserProfile?

  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================================
// Payments Service Schema
// ============================================================================

model Payment {
  id                String        @id @default(uuid())
  senderId          String        @map("sender_id")
  recipientId       String?       @map("recipient_id")
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("USD")
  status            PaymentStatus
  type              PaymentType
  description       String?
  metadata          Json?
  pspTransactionId  String?       @map("psp_transaction_id")
  pspStatus         String?       @map("psp_status")
  failureReason     String?       @map("failure_reason")
  completedAt       DateTime?     @map("completed_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  sender       User                  @relation("SentPayments", fields: [senderId], references: [id])
  recipient    User?                 @relation("ReceivedPayments", fields: [recipientId], references: [id])
  transactions PaymentTransaction[]

  @@index([senderId])
  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model PaymentTransaction {
  id               String        @id @default(uuid())
  paymentId        String        @map("payment_id")
  status           PaymentStatus
  statusMessage    String?       @map("status_message")
  pspTransactionId String?       @map("psp_transaction_id")
  metadata         Json?
  createdAt        DateTime      @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([createdAt])
  @@map("payment_transactions")
}

// ============================================================================
// Admin Service Schema
// ============================================================================

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model SystemConfig {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by")

  @@map("system_config")
}

// ============================================================================
// Profile Service Schema
// ============================================================================

model UserProfile {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  avatarUrl  String?  @map("avatar_url")
  phone      String?
  address    String?
  bio        String?
  preferences Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}
