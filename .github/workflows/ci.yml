name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs when a new workflow with the same group is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Workflow permissions
permissions:
  contents: read
  security-events: write

env:
  NODE_VERSION: '24.11.x'
  PNPM_VERSION: '9'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  # Job 1: Code Quality Checks
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for Nx affected commands

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.pnpm-cache.outputs.STORE_PATH }}
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify Nx installation
        run: |
          pnpm nx --version
          echo "Nx installed successfully"

      - name: Debug - Check installation
        run: |
          echo "=== Checking pnpm list ==="
          pnpm list --depth=0 | head -20 || true
          echo "=== Checking if nx binary exists ==="
          ls -la ./nx
          echo "=== Checking node_modules/.nx ==="
          ls -la node_modules/.nx 2>/dev/null || echo "No .nx directory"
          echo "=== Checking for project.json files ==="
          find apps libs -name "project.json" -type f | wc -l
          echo "=== Testing nx list ==="
          pnpm nx list || true

      - name: Derive appropriate SHAs for base and head
        id: set-shas
        uses: nrwl/nx-set-shas@v4

      - name: Run ESLint (affected)
        run: pnpm nx affected --target=lint --base=${{ steps.set-shas.outputs.base }} --head=${{ steps.set-shas.outputs.head }} --verbose

      - name: Check for projects with typecheck target
        id: typecheck-projects
        run: |
          PROJECTS=$(pnpm nx print-affected --target=typecheck --select=projects --base=${{ steps.set-shas.outputs.base }} --head=${{ steps.set-shas.outputs.head }} 2>/dev/null || echo "")
          if [ -n "$PROJECTS" ]; then
            echo "has_projects=true" >> $GITHUB_OUTPUT
            echo "Projects with typecheck: $PROJECTS"
          else
            echo "has_projects=false" >> $GITHUB_OUTPUT
            echo "No projects with typecheck target found"
          fi

      - name: Run TypeScript type check (affected)
        if: steps.typecheck-projects.outputs.has_projects == 'true'
        run: pnpm nx affected --target=typecheck --base=${{ steps.set-shas.outputs.base }} --head=${{ steps.set-shas.outputs.head }}

  # Job 2: Frontend Unit Tests
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.pnpm-cache.outputs.STORE_PATH }}
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify Nx installation
        run: |
          pnpm nx --version
          echo "Nx installed successfully"

      - name: Derive appropriate SHAs for base and head
        id: set-shas
        uses: nrwl/nx-set-shas@v4

      - name: Run frontend unit tests (all on main/develop)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: |
          pnpm nx run-many --target=test \
            --projects=shell,auth-mfe,payments-mfe,admin-mfe,profile-mfe,shared-auth-store,shared-utils,shared-types \
            --coverage \
            --runInBand

      - name: Run frontend unit tests (affected on feature branches)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
        run: |
          pnpm nx affected --target=test \
            --base=${{ steps.set-shas.outputs.base }} \
            --head=${{ steps.set-shas.outputs.head }} \
            --exclude=*-service,api-gateway \
            --coverage \
            --runInBand

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/apps/shell/lcov.info,./coverage/apps/auth-mfe/lcov.info,./coverage/apps/payments-mfe/lcov.info,./coverage/apps/admin-mfe/lcov.info,./coverage/apps/profile-mfe/lcov.info
          flags: frontend
          name: frontend-coverage
        continue-on-error: true

  # Job 3: Backend Unit Tests
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres-auth:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: auth_db_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-payments:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: payments_db_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-admin:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: admin_db_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5434:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-profile:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: profile_db_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5435:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: testuser
          RABBITMQ_DEFAULT_PASS: testpass
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 30s
          --health-timeout 30s
          --health-retries 3

    env:
      # Database URLs for testing
      AUTH_DATABASE_URL: postgresql://testuser:testpass@localhost:5432/auth_db_test
      PAYMENTS_DATABASE_URL: postgresql://testuser:testpass@localhost:5433/payments_db_test
      ADMIN_DATABASE_URL: postgresql://testuser:testpass@localhost:5434/admin_db_test
      PROFILE_DATABASE_URL: postgresql://testuser:testpass@localhost:5435/profile_db_test
      # Test secrets (not real)
      JWT_SECRET: test-jwt-secret-for-ci-only
      JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci-only
      # Message broker & cache
      RABBITMQ_URL: amqp://testuser:testpass@localhost:5672
      REDIS_URL: redis://localhost:6379
      # Node environment
      NODE_ENV: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.pnpm-cache.outputs.STORE_PATH }}
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify Nx installation
        run: |
          pnpm nx --version
          echo "Nx installed successfully"

      - name: Generate Prisma clients
        run: pnpm db:all:generate

      - name: Run database migrations
        run: |
          cd $GITHUB_WORKSPACE/apps/auth-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/payments-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/admin-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/profile-service && npx prisma migrate deploy

      - name: Derive appropriate SHAs for base and head
        id: set-shas
        uses: nrwl/nx-set-shas@v4

      - name: Run backend unit tests (all on main/develop)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: |
          pnpm nx run-many --target=test \
            --projects=api-gateway,auth-service,payments-service,admin-service,profile-service \
            --coverage \
            --maxWorkers=2

      - name: Run backend unit tests (affected on feature branches)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
        run: |
          pnpm nx affected --target=test \
            --base=${{ steps.set-shas.outputs.base }} \
            --head=${{ steps.set-shas.outputs.head }} \
            --exclude=auth-mfe,payments-mfe,admin-mfe,profile-mfe,shell \
            --coverage \
            --maxWorkers=2

      - name: Upload backend coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/apps/auth-service/lcov.info,./coverage/apps/payments-service/lcov.info,./coverage/apps/admin-service/lcov.info,./coverage/apps/profile-service/lcov.info
          flags: backend
          name: backend-coverage
        continue-on-error: true

  # Job 4: Build All Projects
  build:
    name: Build All Projects
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-and-typecheck]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.pnpm-cache.outputs.STORE_PATH }}
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify Nx installation
        run: |
          pnpm nx --version
          echo "Nx installed successfully"

      - name: Generate Prisma clients
        run: pnpm db:all:generate

      - name: Derive appropriate SHAs for base and head
        id: set-shas
        uses: nrwl/nx-set-shas@v4

      - name: Build all projects (main/develop)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        env:
          # For E2E tests: frontend calls API Gateway directly (no nginx in CI)
          NX_API_BASE_URL: http://localhost:3000/api
        run: |
          pnpm nx run-many --target=build \
            --all \
            --configuration=production \
            --skip-nx-cache

      - name: Build affected projects (feature branches)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
        env:
          # For E2E tests: frontend calls API Gateway directly (no nginx in CI)
          NX_API_BASE_URL: http://localhost:3000/api
        run: |
          pnpm nx affected --target=build \
            --base=${{ steps.set-shas.outputs.base }} \
            --head=${{ steps.set-shas.outputs.head }} \
            --configuration=production \
            --skip-nx-cache

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7
          if-no-files-found: warn

  # Job 5: E2E Tests (Optional, runs on main/develop only)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    needs: [build]

    services:
      postgres-auth:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: auth_db_e2e
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-payments:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: payments_db_e2e
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-admin:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: admin_db_e2e
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5434:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-profile:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: profile_db_e2e
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5435:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: testuser
          RABBITMQ_DEFAULT_PASS: testpass
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 30s
          --health-timeout 30s
          --health-retries 3

    env:
      AUTH_DATABASE_URL: postgresql://testuser:testpass@localhost:5432/auth_db_e2e
      PAYMENTS_DATABASE_URL: postgresql://testuser:testpass@localhost:5433/payments_db_e2e
      ADMIN_DATABASE_URL: postgresql://testuser:testpass@localhost:5434/admin_db_e2e
      PROFILE_DATABASE_URL: postgresql://testuser:testpass@localhost:5435/profile_db_e2e
      JWT_SECRET: test-jwt-secret-e2e
      JWT_REFRESH_SECRET: test-jwt-refresh-secret-e2e
      RABBITMQ_URL: amqp://testuser:testpass@localhost:5672
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for Nx affected commands

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Generate Prisma clients
        run: pnpm db:all:generate

      - name: Run database migrations
        run: |
          cd $GITHUB_WORKSPACE/apps/auth-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/payments-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/admin-service && npx prisma migrate deploy
          cd $GITHUB_WORKSPACE/apps/profile-service && npx prisma migrate deploy

      - name: Seed auth database for E2E tests
        run: pnpm db:auth:seed

      - name: Start backend services
        run: |
          pnpm dev:backend &
          echo "Waiting for backend services to be ready..."
          # Wait for API Gateway health endpoint (it depends on other services)
          for i in {1..60}; do
            if curl -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "API Gateway is ready!"
              break
            fi
            echo "Waiting for API Gateway... ($i/60)"
            sleep 2
          done
          # Additional buffer for all services to stabilize
          sleep 5

      - name: Run E2E tests
        run: pnpm nx e2e shell-e2e
        # Note: Playwright will start the frontend preview servers automatically
        # via webServer config in playwright.config.ts

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # Job 6: Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        # Pin to specific version for security and reproducibility
        # Version 0.33.1 - see https://github.com/aquasecurity/trivy-action/releases
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run npm audit
        run: |
          npm audit --audit-level=high || true
        continue-on-error: true

  # Job 7: Report Status
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test-frontend, test-backend, build]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          if [ "${{ needs.lint-and-typecheck.result }}" != "success" ] || \
             [ "${{ needs.test-frontend.result }}" != "success" ] || \
             [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
          fi
