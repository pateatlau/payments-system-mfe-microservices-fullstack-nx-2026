# Docker Compose for POC-3 Local Development
# Provides full infrastructure for production-ready microservices
#
# Services:
#   - nginx: Reverse proxy with SSL/TLS termination
#   - auth_db: PostgreSQL database for Auth Service
#   - payments_db: PostgreSQL database for Payments Service
#   - admin_db: PostgreSQL database for Admin Service
#   - profile_db: PostgreSQL database for Profile Service
#   - rabbitmq: Message broker for event hub
#   - redis: Caching layer
#   - postgres (legacy): Shared database for migration compatibility
#   - prometheus: Metrics collection
#   - grafana: Metrics visualization and dashboards
#   - jaeger: Distributed tracing
#
# Usage:
#   docker-compose up -d                    # Start all services
#   docker-compose up -d prometheus grafana # Start observability only
#   docker-compose down                     # Stop services
#   docker-compose ps                       # Check service status
#   docker-compose logs -f                  # View logs
#
# Observability URLs:
#   - Prometheus: http://localhost:9090
#   - Grafana: http://localhost:3010 (admin/admin)
#   - Jaeger: http://localhost:16686

services:
  # =============================================================================
  # nginx Reverse Proxy
  # =============================================================================
  nginx:
    image: nginx:latest
    container_name: mfe-nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      rabbitmq:
        condition: service_healthy
    healthcheck:
      # Health check will be configured once nginx.conf is available
      # Using basic nginx process check for now
      test:
        [
          'CMD-SHELL',
          'test -f /var/run/nginx.pid && kill -0 `cat /var/run/nginx.pid` || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  # =============================================================================
  # Separate Databases per Service (POC-3)
  # =============================================================================

  # Auth Service Database
  auth_db:
    image: postgres:16
    container_name: mfe-auth-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: auth_db
    ports:
      - '5432:5432'
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d auth_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Payments Service Database
  payments_db:
    image: postgres:16
    container_name: mfe-payments-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: payments_db
    ports:
      - '5433:5432'
    volumes:
      - payments_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d payments_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Admin Service Database
  admin_db:
    image: postgres:16
    container_name: mfe-admin-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: admin_db
    ports:
      - '5434:5432'
    volumes:
      - admin_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d admin_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Profile Service Database
  profile_db:
    image: postgres:16
    container_name: mfe-profile-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: profile_db
    ports:
      - '5435:5432'
    volumes:
      - profile_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d profile_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # Legacy Shared Database (for migration compatibility)
  # =============================================================================
  postgres:
    image: postgres:16
    container_name: mfe-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mfe_poc2
    ports:
      - '5436:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # RabbitMQ Event Hub (POC-3)
  # =============================================================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: mfe-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      RABBITMQ_ERLANG_COOKIE: SWQOKODSQALRPCLNMEQGSWQOKODS
    ports:
      - '5672:5672' # AMQP
      - '15672:15672' # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    # RabbitMQ uses RABBITMQ_ERLANG_COOKIE env var for cluster auth and persistence
    # Do NOT regenerate .erlang.cookie on startup; let RabbitMQ manage it
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'ping']
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # Redis (Caching Only - POC-3)
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: mfe-redis
    command: redis-server --appendonly yes
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # Observability Stack (POC-3)
  # =============================================================================

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: mfe-prometheus
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:9090/-/healthy']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  # Grafana - Metrics Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: mfe-grafana
    ports:
      - '3010:3000'
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3010
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    healthcheck:
      test:
        ['CMD', 'wget', '-q', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - mfe-network

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: mfe-jaeger
    ports:
      - '16686:16686' # Jaeger UI
      - '4317:4317' # OTLP gRPC
      - '4318:4318' # OTLP HTTP
      - '14268:14268' # Jaeger thrift HTTP
      - '14250:14250' # Jaeger gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:16686/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  auth_db_data:
    driver: local
  payments_db_data:
    driver: local
  admin_db_data:
    driver: local
  profile_db_data:
    driver: local
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  mfe-network:
    driver: bridge
