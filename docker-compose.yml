# Docker Compose for POC-3 Local Development
# Provides full infrastructure for production-ready microservices
#
# Services:
#   - nginx: Reverse proxy with SSL/TLS termination
#   - auth_db: PostgreSQL database for Auth Service
#   - payments_db: PostgreSQL database for Payments Service
#   - admin_db: PostgreSQL database for Admin Service
#   - profile_db: PostgreSQL database for Profile Service
#   - rabbitmq: Message broker for event hub
#   - redis: Caching layer
#   - postgres (legacy): Shared database for migration compatibility
#
# Usage:
#   docker-compose up -d          # Start services in background
#   docker-compose down           # Stop services
#   docker-compose ps             # Check service status
#   docker-compose logs -f        # View logs

version: '3.8'

services:
  # =============================================================================
  # nginx Reverse Proxy
  # =============================================================================
  nginx:
    image: nginx:latest
    container_name: mfe-nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  # =============================================================================
  # Separate Databases per Service (POC-3)
  # =============================================================================

  # Auth Service Database
  auth_db:
    image: postgres:16
    container_name: mfe-auth-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: auth_db
    ports:
      - '5432:5432'
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d auth_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Payments Service Database
  payments_db:
    image: postgres:16
    container_name: mfe-payments-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: payments_db
    ports:
      - '5433:5432'
    volumes:
      - payments_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d payments_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Admin Service Database
  admin_db:
    image: postgres:16
    container_name: mfe-admin-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: admin_db
    ports:
      - '5434:5432'
    volumes:
      - admin_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d admin_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # Profile Service Database
  profile_db:
    image: postgres:16
    container_name: mfe-profile-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: profile_db
    ports:
      - '5435:5432'
    volumes:
      - profile_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d profile_db']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # Legacy Shared Database (for migration compatibility)
  # =============================================================================
  postgres:
    image: postgres:16
    container_name: mfe-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mfe_poc2
    ports:
      - '5436:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # RabbitMQ Event Hub (POC-3)
  # =============================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: mfe-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - '5672:5672' # AMQP
      - '15672:15672' # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'ping']
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - mfe-network

  # =============================================================================
  # Redis (Caching Only - POC-3)
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: mfe-redis
    command: redis-server --appendonly yes
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - mfe-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  auth_db_data:
    driver: local
  payments_db_data:
    driver: local
  admin_db_data:
    driver: local
  profile_db_data:
    driver: local
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  redis_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  mfe-network:
    driver: bridge
